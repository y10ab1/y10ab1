name: Cache README Cards

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write

concurrency:
  group: cache-readme-cards
  cancel-in-progress: true

jobs:
  cache-cards:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure assets directory
        run: mkdir -p assets

      - name: Download + validate SVGs
        shell: bash
        run: |
          set -euo pipefail

          fetch_svg () {
            local url="$1"
            local out="$2"
            local tmp
            tmp="$(mktemp)"

            echo "Fetching: $url"
            # -f: HTTP error => fail
            # -L: follow redirects
            # --retry: handle transient failures
            curl -fsSL --retry 3 --retry-delay 2 \
              -H "Accept: image/svg+xml" \
              "$url" -o "$tmp"

            # Validate it looks like an SVG
            if ! head -c 200 "$tmp" | grep -qi "<svg"; then
              echo "ERROR: Downloaded file is not SVG for $out"
              echo "First 200 bytes:"
              head -c 200 "$tmp" || true
              rm -f "$tmp"
              exit 1
            fi

            mv "$tmp" "$out"
            echo "Saved: $out ($(wc -c < "$out") bytes)"
          }

          fetch_svg "https://github-readme-stats.vercel.app/api?username=y10ab1&show_icons=true&locale=en&theme=radical&cache_seconds=21600" "assets/stats.svg"
          fetch_svg "https://github-readme-stats.vercel.app/api/top-langs/?username=y10ab1&layout=compact&locale=en&theme=radical&cache_seconds=21600" "assets/top-langs.svg"
          fetch_svg "https://streak-stats.demolab.com?user=y10ab1&theme=radical" "assets/streak.svg"

      - name: Commit & push if changed
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(assets): update cached README cards"
          file_pattern: assets/*.svg
          commit_user_name: readme-cards ðŸ¤–
          commit_user_email: actions@github.com
          commit_author: readme-cards ðŸ¤– <actions@github.com>
